#!/bin/bash
#
# Usage: robot-masterd repository [robot-master-flags]
#
[ $# = 0 ] && echo "Usage: robot-masterd repository [robot-master-flags]" && exit -1

# parse arguments
repository=$1
shift

# validate parameters
test ! -d "config/workflows/${repository}" && \
  echo "robot-masterd: No '$repository' configuration files" && exit -1

test ! -x bin/robot-master && \
  echo "robot-masterd: Cannot execute 'bin/robot-master'" && exit -1

# remove pidfile on exit
pidfile="${ROBOT_MASTERD_PIDFILE:-robot-masterd.pid}"
trap "rm $pidfile; exit" SIGHUP SIGINT SIGTERM
echo $$ > $pidfile

# work forever running robot-master on the repository workflows
PATH=bin:$PATH
while [ -r $pidfile ]; do
  for fn in config/workflows/${repository}/*WF.xml; do
    robot-master $* "${repository}:$(basename ${fn} .xml)"
    sleep 1
  done
  sleep ${ROBOT_MASTERD_SLEEP:-60}
done
