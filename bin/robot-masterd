#!/bin/bash
#
# Usage: robot-masterd repository [robot-master-flags]
#
[ $# = 0 ] && echo "Usage: robot-masterd repository [robot-master-flags]" && exit -1

# parse arguments
repository=$1
shift

# validate parameters
test ! -d "config/workflows/${repository}" && \
  echo "robot-masterd: No '$repository' configuration files" && exit -1

test ! -x bin/robot-master && \
  echo "robot-masterd: Cannot execute 'bin/robot-master'" && exit -1

# setup environment
PATH=bin:$PATH
nsec=${ROBOT_MASTERD_SLEEP:-5}
pidfile=${ROBOT_MASTERD_PIDFILE:-robot-masterd.pid}

# remove pidfile on exit
trap "rm $pidfile; exit" SIGHUP SIGINT SIGTERM
echo $$ > $pidfile

# work forever running robot-master on the repository workflows
while [ true ]; do
  for fn in config/workflows/${repository}/*WF.xml; do
    robot-master $* "${repository}:$(basename ${fn} .xml)"
    sleep $nsec
  done
  sleep $nsec
done
